---
title: "Powell - Viz Doc"
format: html
editor: visual
---



## Data import

```{r}
library(tidyverse)


```


## Viz 1 - Interactive data Table

1. import data year by year

```{r}

offense_data_2018 <- read.csv("data/DC-2018/NIBRS_OFFENSE.csv") %>% mutate(year = 2018)
location_2018 <- read.csv("data/DC-2018/NIBRS_LOCATION_TYPE.csv")
offense_2018 <- read.csv("data/DC-2018/NIBRS_OFFENSE_TYPE.csv")
offense_data_2018 <- left_join(offense_data_2018,location_2018, by = "LOCATION_ID")
offense_data_2018 <- left_join(offense_data_2018,offense_2018, by = "OFFENSE_TYPE_ID")
print(dim(offense_data_2018))

offense_data_2019 <- read.csv("data/DC-2019/NIBRS_OFFENSE.csv") %>% mutate(year = 2019)
location_2019 <- read.csv("data/DC-2019/NIBRS_LOCATION_TYPE.csv")
offense_2019 <- read.csv("data/DC-2019/NIBRS_OFFENSE_TYPE.csv")
offense_data_2019 <- left_join(offense_data_2019,location_2019, by = "LOCATION_ID")
offense_data_2019 <- left_join(offense_data_2019,offense_2019, by = "OFFENSE_TYPE_ID")
print(dim(offense_data_2019))

offense_data_2020 <- read.csv("data/DC-2020/NIBRS_OFFENSE.csv") %>% mutate(year = 2020)
location_2020 <- read.csv("data/DC-2020/NIBRS_LOCATION_TYPE.csv")
offense_2020 <- read.csv("data/DC-2020/NIBRS_OFFENSE_TYPE.csv")
offense_data_2020 <- left_join(offense_data_2020,location_2020, by = "LOCATION_ID")
offense_data_2020 <- left_join(offense_data_2020,offense_2020, by = "OFFENSE_TYPE_ID")
print(dim(offense_data_2020))

offense_data_2021 <- read.csv("data/DC-2021/NIBRS_OFFENSE.csv") %>% mutate(year = 2021)
location_2021 <- read.csv("data/DC-2021/NIBRS_LOCATION_TYPE.csv")
offense_2021 <- read.csv("data/DC-2021/NIBRS_OFFENSE_TYPE.csv")
offense_data_2021 <- left_join(offense_data_2021,location_2021, by = "location_id")
offense_data_2021 <- left_join(offense_data_2021,offense_2021, by = "offense_code")
print(dim(offense_data_2021))

offense_data_2022 <- read.csv("data/DC-2022/NIBRS_OFFENSE.csv") %>% mutate(year = 2022)
location_2022 <- read.csv("data/DC-2022/codes/NIBRS_LOCATION_TYPE.csv")
offense_2022 <- read.csv("data/DC-2022/codes/NIBRS_OFFENSE_TYPE.csv")
offense_data_2022 <- left_join(offense_data_2022,location_2022, by = "location_id")
offense_data_2022 <- left_join(offense_data_2022,offense_2022, by = "offense_code")
print(dim(offense_data_2022))

```


2. find package to do this again
  https://towardsdatascience.com/top-7-packages-for-making-beautiful-tables-in-r-7683d054e541
3. merge data as needed
```{r}

offense_data_bundle1 = rbind(offense_data_2018,offense_data_2019,offense_data_2020)
offense_data_bundle2 = rbind(offense_data_2021,offense_data_2022)

colnames(offense_data_bundle1) = tolower(colnames(offense_data_bundle1))

offense_data_bundle1 <- offense_data_bundle1 %>% select(-c(offense_type_id, offense_code))
offense_data_bundle2 <- offense_data_bundle2 %>% select(-c(offense_code))

for(i in 1:ncol(offense_data_bundle1)){
  #print(i)
  #print(colnames(offense_data_bundle1)[i])
  #print(colnames(offense_data_bundle2)[i])
}

offense_data_total = rbind(offense_data_bundle1,offense_data_bundle2)

offense_data_total$location_name %>% table() %>% as.data.frame()
offense_data_total$offense_name %>% table() %>% as.data.frame()

table_data = offense_data_total %>% group_by(year,offense_name) %>% tally() %>%
  spread(year,n)

colnames(table_data)[1] <- "Offense"
rownames(table_data) <- NULL

```

4. Arrange data

```{r}

library(DT)

datatable(data = table_data,
          caption = "Table",
          filter = "top")

## Sans serif font
## format numbers with commas for thousands

```



## Viz 2 - Treemap

1. import data year by year
2. find package to do this again
  https://plotly.com/r/treemaps/
  https://community.plotly.com/t/how-can-i-display-percentage-subtotals-at-each-category-level-in-treemap-chart/68142
3. merge data as needed
4. Arrange data

```{r}
library(plotly)
library(ggplot2)
#library(treemap)
#library(d3Tree)
library(treemapify)

table_data2 = offense_data_total %>% group_by(location_name) %>% tally()
colnames(table_data2) <- c("Location","Amount")

plot <- ggplot(table_data2, aes(area = Amount, fill = Location, label = Location)) + 
  geom_treemap() + 
  geom_treemap_text() +
  theme(legend.position = "none")

## Don't totally aggregate
## Too many categories, could group, other option
### Bar plot may be easier, areas are harder to compare
```


## Network connections

going crazy here

```{r}
offense_data_total %>% nrow()
offense_data_total$incident_id %>% unique() %>% length()
offense_data_total$offense_id %>% unique() %>% length()

duplicated_data <- offense_data_total[offense_data_total$incident_id %in% offense_data_total$incident_id[duplicated(offense_data_total$incident_id)],]

num_incidents <- duplicated_data$incident_id %>% unique()

adjacency_list <- c("source","target") %>% t() %>% as.data.frame()

#length(num_incidents)
```


```{r}
adjacency_list <- c("source","target") %>% t() %>% as.data.frame()

for(i in 1:length(num_incidents)){
  print(i)
  incident_instance <- num_incidents[i]
  incident_df <- duplicated_data %>% filter(incident_id == incident_instance)
  for(g in 1:(nrow(incident_df)-1)){
    if(g == nrow(incident_df)){
      life = 0
    }
    for(f in (g+1):nrow(incident_df)){
      insert <- c(incident_df[g,11],incident_df[f,11])
      adjacency_list <- rbind(adjacency_list, insert)
    }
  }
}
  
colnames(adjacency_list) <- adjacency_list[1,]
adjacency_list <- adjacency_list[-1,]


```

```{r}
adjacency_matrix <- as.matrix(adjacency_list)
adjacency_matrix <- get.adjacency(graph.edgelist(adjacency_matrix)) %>% as.matrix()

crime_names <- rownames(adjacency_matrix) %>% as.data.frame()

offense_freq <- offense_data_total$offense_name %>% table() %>% as.data.frame()
offense_freq$Freq <- (offense_freq$Freq-mean(offense_freq$Freq))/ sd(offense_freq$Freq)

crime_stats <- left_join(crime_names, offense_freq)

```


```{r}

library(plotly)
library(ggnetwork)
library(network)
library(sna)
library(ggplot2)
library(GGally)
library(intergraph)

#network <- asNetwork(network)
net = network(adjacency_matrix, directed = FALSE)


net %v% "Crime" = crime_stats$.
net %v% "Freq" = crime_stats$Freq
net %v% "Label" = crime_stats$.

list.edge.attributes(net)

net <- set.edge.value(net, "Weight", adjacency_matrix)

p <- ggnet2(net,
            mode = "circle",
            node.size = "Freq",
            node.color = "Crime",
            edge.size = "Weight",
            edge.color = "grey",
            edge.alpha = .5) +
  theme(legend.position = "none")

ggplotly(p, )


```










